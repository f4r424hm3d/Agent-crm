# Backend History - 21-02-26

## API Changes
- Updated `approveAgent` and `createAgent` endpoints to use dynamic emails from settings.
- Added `canLogin` field to `Agent` model to control login permissions.

## Database Changes
- **Agent Model**: Added `canLogin` (Boolean, default: true).
- **Agent Model**: Ensured `agentCode` and `passwordSetupToken` are handled securely.

## Logic Updates
- **Token Security**: Implemented SHA-256 hashing for `passwordSetupToken` and `passwordResetToken` before storage.
- **Authentication**: Updated `agentLogin`, `setupPassword`, and `resetPassword` to handle hashed token comparison.
- **Agent ID**: Integrated automatic `agentCode` generation (e.g., AG1001) during agent approval/creation.
- **Activity Status**: Implemented logic to calculate application counts for the last 30 days and map to status labels (Active/Moderate/Inactive).
- **Permissions**: Implemented `toggleLoginPermission` logic and integrated `canLogin` check in `authMiddleware`. Added `reason: 'PERMISSION_REVOKED'` and `role: 'AGENT'` to 403 response for robust frontend redirection.
- **Agent Controller**: Added `email` to `allowedFields` in `updateAgent` method to permit administrators to modify agent email addresses.
- **Audit Logging**: Enhanced audit logs for agent updates to include email changes.
- **Bug Fix**: Resolved 500 Internal Server Error in `AgentController.toggleLoginPermission` caused by incorrect `AuditService.logUpdate` signature.

## Bug Fixes
- Fixed approval email not being sent when agent status was changed to approved.
- Corrected corrupted `resetPassword` logic that was breaking token validation.
- Fixed 500 error in `authController.registerAgent` caused by SyntaxError (extra brace).
- Fixed `ReferenceError: moveFileToAgentFolder is not defined` in `agentController.js`.

## File Operation Tracking

### Files Updated
- `backend/src/controllers/authController.js` (Refactored `registerAgent`, fixed syntax errors).
- `backend/src/controllers/agentController.js` (Corrected `moveFileToEntityFolder` call).
- `backend/src/middlewares/authMiddleware.js` (Added `canLogin` status check).
- `backend/src/models/Agent.js` (Added `canLogin` field).

### Files Archived (delete folder)
- `backend/src/scripts/seed.js` -> `delete/backend/src/scripts/seed.js`
- `backend/src/scripts/seedBrochure.js` -> `delete/backend/src/scripts/seedBrochure.js`
